@page "/"
@inject RestaurantSystemFacade Facade
@inject RankingService RankingService
@inject RankingObserver Observer
@inject RestaurantService RestaurantService

<PageTitle>Home - Boolk</PageTitle>

<div class="hero">
    <div class="hero-content">
        <h1>Discover the Best Restaurants</h1>
        <p>Find top-rated restaurants ranked by value, price, and satisfaction</p>
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <button class="btn btn-primary" @onclick="LoadRankedRestaurants">
                @if (isLoading)
                {
                    <span class="spinner" style="width: 20px; height: 20px; border-width: 2px; display: inline-block; margin-right: 0.5rem;"></span>
                }
                View Rankings
            </button>
            <a href="/restaurants" class="btn btn-secondary">Add Restaurant</a>
        </div>
    </div>
</div>

<div class="container mt-5">
    <div class="card mb-5">
        <div class="card-header">
            <h2 class="card-title">Ranking Strategy</h2>
        </div>
        <div class="mb-4">
            <label for="strategySelect" class="form-label">Select Ranking Strategy:</label>
            <select @bind="selectedStrategy" @bind:event="onchange" class="form-select" id="strategySelect">
                <option value="bestvalue">ğŸ† Best Value - Best satiety per price</option>
                <option value="cheapest">ğŸ’° Cheapest - Lowest average price</option>
                <option value="mostfilling">ğŸ” Most Filling - Highest satiety level</option>
            </select>
        </div>
        <button class="btn btn-primary" @onclick="LoadRankedRestaurants" disabled="@isLoading">
            @if (isLoading)
            {
                <span class="spinner" style="width: 20px; height: 20px; border-width: 2px; display: inline-block; margin-right: 0.5rem;"></span>
            }
            Apply Strategy
        </button>
    </div>

    @if (rankedRestaurants != null && rankedRestaurants.Any())
    {
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Top Restaurants</h2>
            </div>
            <div class="grid grid-3" style="padding: 1rem;">
                @foreach (var (restaurant, index) in rankedRestaurants.Select((r, i) => (r, i + 1)))
                {
                    <a href="/restaurant/@restaurant.Id" style="text-decoration: none; color: inherit;">
                        <div class="restaurant-card fade-in" style="@($"animation-delay: {index * 0.1}s")">
                            <div class="rank-badge @GetRankClass(index)">
                                @index
                            </div>
                            <h3 class="restaurant-name">@restaurant.Name</h3>
                            <p class="restaurant-city">ğŸ“ @restaurant.City</p>
                            <span class="restaurant-type">@GetRestaurantType(restaurant)</span>
                        </div>
                    </a>
                }
            </div>
        </div>
    }
    else if (rankedRestaurants != null && !rankedRestaurants.Any())
    {
        <div class="card">
            <div style="text-align: center; padding: 3rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ½ï¸</div>
                <h3 style="margin-bottom: 1rem;">No restaurants found</h3>
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                    Get started by adding some restaurants and reviews!
                </p>
                <a href="/restaurants" class="btn btn-primary">Add Your First Restaurant</a>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div style="text-align: center; padding: 3rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ‘†</div>
                <h3 style="margin-bottom: 1rem;">Select a strategy and load rankings</h3>
                <p style="color: var(--text-secondary);">
                    Choose your preferred ranking method above and click "Apply Strategy"
                </p>
            </div>
        </div>
    }
</div>

@code {
    private List<RestaurantBase>? rankedRestaurants;
    private bool isLoading = false;
    private string selectedStrategy = "bestvalue";

    protected override void OnInitialized()
    {
        RankingService.Attach(Observer);
    }

    private async Task LoadRankedRestaurants()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            await Task.Delay(300); // Smooth loading animation
            
            IRankingStrategy strategy = selectedStrategy switch
            {
                "bestvalue" => new BestValueStrategy(),
                "cheapest" => new CheapestStrategy(),
                "mostfilling" => new MostFillingStrategy(),
                _ => new BestValueStrategy()
            };

            rankedRestaurants = await Facade.GetRankedRestaurants(strategy);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading restaurants: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string GetRestaurantType(RestaurantBase restaurant)
    {
        return restaurant.GetType().Name switch
        {
            "FastFoodRestaurant" => "ğŸŸ Fast Food",
            "StudentBar" => "ğŸº Student Bar",
            "PremiumRestaurant" => "â­ Premium",
            _ => restaurant.GetType().Name
        };
    }

    private string GetRankClass(int rank)
    {
        return rank switch
        {
            1 => "gold",
            2 => "silver",
            3 => "bronze",
            _ => ""
        };
    }
}
