@page "/profile"
@inject UserService UserService
@inject NavigationManager Nav
@inject IReviewRepository ReviewRepository
@inject IJSRuntime JsRuntime
@inject IRestaurantRepository RestaurantRepository
<PageTitle>Profile - Boolk</PageTitle>

@if (!isInitialized)
{
    <p>Loading...</p>
}
else
{
    <!-- HERO -->
    <div class="hero">
        <div class="hero-content">
            @if (UserService.CurrentUser != null)
            {
                <h1>üëã Welcome back, @UserService.CurrentUser.Name!</h1>
                <p>Manage your account and reviews</p>
            }
            else
            {
                <h1>üë§ Your Profile</h1>
                <p>Manage your account and authentication</p>
            }
           

            @if (UserService.CurrentUser == null)
            {
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <a href="/login" class="btn btn-primary">üîê Login</a>
                    <a href="/register" class="btn btn-secondary">‚ú® Register</a>
                </div>
            }
            else
            {
                <button class="btn btn-danger" @onclick="Logout">
                    üö™ Logout
                </button>
            }
        </div>
    </div>

    <div class="container mt-5">

        @if (UserService.CurrentUser == null)
        {
            <!-- AUTH OPTIONS -->
            <div class="card mb-5">
                <div class="card-header">
                    <h2 class="card-title">Authentication</h2>
                </div>

                <div class="grid grid-2" style="padding: 1.5rem;">

                    <!-- EMAIL AUTH -->
                    <div class="restaurant-card">
                        <h3>üìß Email & Password</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Login or register using your email address.
                        </p>
                        <a href="/login" class="btn btn-primary">Login</a>
                        <a href="/register" class="btn btn-secondary" style="margin-left: .5rem;">
                            Register
                        </a>
                    </div>

                    <!-- GOOGLE AUTH -->
                    <div class="restaurant-card">
                        <h3>üîµ Google Sign-In</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Sign in quickly using your Google account.
                        </p>

                        <!-- PLACEHOLDER -->
                        <button class="btn btn-outline" disabled>
                            Continue with Google
                        </button>

                        <small style="display: block; margin-top: .5rem; color: var(--text-secondary);">
                            (Coming soon)
                        </small>
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- USER INFO -->
            <div class="card mb-5" style="margin-bottom: 2rem">
                <div class="card-header">
                    <h2 class="card-title">Account Details</h2>
                </div>

                <div class="grid grid-2" style="padding: 1.5rem; align-items: center;">
                    <div>
                        <h3>Name: @UserService.CurrentUser.Name</h3>
                        <h3>Birth Date: @UserService.CurrentUser.BirthDate.ToLocalTime().ToString("MM/dd/yyyy")</h3>
                        <h3>Email: @UserService.CurrentUser.Email</h3>
                    </div>

                    
                </div>
            </div>

            <!-- USER REVIEWS -->
            @if (userReviews != null && userReviews.Any())
            {
                <div class="card mb-5" style="margin-top: 2rem">
                    <div class="card-header">
                        <h2 class="card-title">üí¨ Your Reviews</h2>
                    </div>
                    <div style="padding: 1rem;">
                        @foreach (var review in userReviews)
                        {
                            <div class="review-card mb-3">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <strong>@GetRestaurantName(review.RestaurantId)</strong>
                                        <div style="font-size:0.8rem; color: var(--text-secondary);">
                                            Review ID: @review.Id.ToString().Substring(0,8)...
                                        </div>
                                        <div style="font-size:0.8rem; color: var(--text-secondary);">
                                            @review.CreatedAt.ToLocalTime().ToString("dd MMM yyyy HH:mm")
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteReview(review.Id)">
                                        üóë Delete
                                    </button>
                                </div>
                                <div>
                                    <span>‚Ç¨@review.Price.ToString("F2")</span> | Satiety: @review.SatietyLevel/10
                                </div>
                                @if (!string.IsNullOrEmpty(review.Comment))
                                {
                                    <p>@review.Comment</p>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>
}

@code {
    private bool isInitialized = false;
    private bool firstRenderDone = false;
    private List<Review>? userReviews;
    private List<RestaurantBase>? restaurants;
    

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !firstRenderDone)
        {
            firstRenderDone = true;

            await UserService.InitializeAsync();
            isInitialized = true;

            if (UserService.CurrentUser != null)
            {
                userReviews = (await ReviewRepository.GetByUserIdAsync(UserService.CurrentUser.Id)).ToList();
                restaurants = (await RestaurantRepository.GetAllAsync()).ToList();
            }

            StateHasChanged();
        }
    }

    private async Task Logout()
    {
        await UserService.Logout();
        Nav.NavigateTo("/");
    }

    private async Task DeleteReview(Guid reviewId)
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this review?");
        if (!confirmed) return;

        await ReviewRepository.DeleteAsync(reviewId);

        if (UserService.CurrentUser != null)
        {
            userReviews = (await ReviewRepository.GetByUserIdAsync(UserService.CurrentUser.Id)).ToList();
        }

        StateHasChanged();
    }

    private string GetRestaurantName(Guid restaurantId)
    {
        var restaurant = restaurants?.FirstOrDefault(r => r.Id == restaurantId);
        return restaurant != null ? $"{restaurant.Name} - {restaurant.City}" : "Unknown Restaurant";
    }
}
